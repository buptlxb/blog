<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>BLxG</title>
    <meta name="description" content="">
    <meta name="author" content="ictlxb">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="./theme/html5.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="./theme/images/icons/favicon.ico"/>
    <link rel="bookmark" href="./theme/images/icons/favicon.ico"/>
    <!-- Le styles -->
    <link href="./theme/bootstrap.min.css" rel="stylesheet">
    <link href="./theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="./theme/local.css" rel="stylesheet">
    <link href="./theme/pygments.css" rel="stylesheet">

    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="http://gotit.sinaapp.com/feeds/all.atom.xml" rel="alternate" title="BLxG" type="application/atom+xml">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href=".">BLxG</a>

        <div class="nav-collapse">
        <ul class="nav">
            
            <li><a href="./pages/about.html">About</a></li>
        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
    <div class='article'>
        <div class="content-title">
            <h1>Several Problems about Linux Kernel</h1>
Sun 13 April 2014

by <a class="url fn" href="./author/ictlxb.html">ictlxb</a>
 


        </div>
	
        <div><blockquote>
<p>There are several problems, which deserve being thought carefully, about linux kernel(version 0.11).
I will not give detail answers to the following questions, but give a brief outline for each question.
I do NOT promise the answers is exactly correct. 
if you find any mistake, please email liuxuebao AT ict.ac.cn. Thank you!
Have fun!
Good luck!</p>
</blockquote>
<h4>1. Why BIOS is executed in the beginning after computer setup? Why not the Operating System?</h4>
<p>The root cause might be the <code>von Neumann architecture</code>.(CPU can only execute the code residing in the main memory.)</p>
<p>The main memory is usually made of RAM in current computers.(RAM will lose all datas without power.)</p>
<p>Therefore, there is no code in main memory to be executed just after computer setup.</p>
<p>The code contained in BIOS will be executed first to boot the OS in the external storage such as disk, floppy and so on.</p>
<h4>2. Why BIOS just loads the first sector of the disk, which is so-called bootsect, and the successive sectors is loaded by bootsect? Why not load all sectors through the BIOS?</h4>
<p>It might be <code>historical reasons</code> that Only the first sector of the disk is loaded by BIOS.Why not the second one, the third one and so on? It is just a convention.</p>
<p>But the connvention is necessary and crucial because the BIOS and the OS are developed seperately by different teams. They known nothing about each other and cannot cooperate with each other without the conventions.  A good convention can give both of the BIOS and the OS scalability. The BIOS or the OS just cares about the functionality of itself and conform to the conventions.</p>
<p>Different OSs might have different memory layouts. So, the BIOS load the bootsect rather than all of the sectors in order that the OS manage the memory itself and the BIOS keep simple and naive. The better the convention is, the less the BIOS and OS depend on each other.</p>
<h4>3. Why the BIOS load the bootsect to the address 0x07c00 instand of 0x00000? Why bootsect is moved to the address 0x90000 after being loaded? Why not load to the correct address at the first time?</h4>
<p>It might also be <code>historical reasons</code>.</p>
<p>In the convention, the interrupt vector table is loaded to the address 0x00000. Obviously, if you load the bootsect here, the interrupt vector table  will be overwrittern by it. Nothing serious will happen if you are sure what you do.</p>
<p>The bootsect is moved to the address 0x90000 becuase of the memory layouts of linux kernel(version 0.11). You can give some details about the layouts.</p>
<h4>4. How the bootsect, the setup and the head cooperate(connect) with each other? Give some evidences(code).</h4>
<p>We can easily find the follow assembly code in <code>boot/bootsect.s</code>, which makes the execution turn to setup.</p>
<div class="highlight"><pre>    <span class="nf">SETUPSEG</span> <span class="err">=</span> <span class="mi">0x9020</span>           <span class="err">!</span> <span class="no">setup</span> <span class="no">starts</span> <span class="no">here</span> 

    <span class="no">...</span>

<span class="err">!</span> <span class="nf">after</span> <span class="no">that</span> <span class="p">(</span><span class="no">everyting</span> <span class="no">loaded</span><span class="p">),</span> <span class="no">we</span> <span class="no">jump</span> <span class="no">to</span>                                                                                                           
<span class="err">!</span> <span class="no">the</span> <span class="no">setup-routine</span> <span class="no">loaded</span> <span class="no">directly</span> <span class="no">after</span>
<span class="err">!</span> <span class="nf">the</span> <span class="no">bootblock</span><span class="p">:</span>

    <span class="nf">jmpi</span>    <span class="mi">0</span><span class="p">,</span><span class="no">SETUPSEG</span>
</pre></div>


<p>Similarly, the follow assembly code, which makes the execution turn to head, can be found in <code>boot/setup.s</code>.</p>
<div class="highlight"><pre><span class="err">!</span> <span class="nf">Well</span><span class="p">,</span> <span class="no">now</span> <span class="no">is</span> <span class="no">the</span> <span class="no">time</span> <span class="no">to</span> <span class="no">actually</span> <span class="no">move</span> <span class="no">into</span> <span class="no">protected</span> <span class="no">mode.</span> <span class="no">To</span> <span class="no">make</span>
<span class="err">!</span> <span class="nf">things</span> <span class="no">as</span> <span class="no">simple</span> <span class="no">as</span> <span class="no">possible</span><span class="p">,</span> <span class="no">we</span> <span class="no">do</span> <span class="no">no</span> <span class="no">register</span> <span class="no">set-up</span> <span class="no">or</span> <span class="no">anything</span><span class="p">,</span>
<span class="err">!</span> <span class="nf">we</span> <span class="no">let</span> <span class="no">the</span> <span class="no">gnu-compiled</span> <span class="mi">32</span><span class="p">-</span><span class="no">bit</span> <span class="no">programs</span> <span class="no">do</span> <span class="no">that.</span> <span class="no">We</span> <span class="no">just</span> <span class="no">jump</span> <span class="no">to</span>
<span class="err">!</span> <span class="nf">absolute</span> <span class="no">address</span> <span class="mi">0x00000</span><span class="p">,</span> <span class="no">in</span> <span class="mi">32</span><span class="p">-</span><span class="no">bit</span> <span class="no">protected</span> <span class="no">mode.</span>

    <span class="nf">mov</span> <span class="no">ax</span><span class="p">,</span><span class="c">#0x0001  ! protected mode (PE) bit</span>
    <span class="nf">lmsw</span>    <span class="no">ax</span>      <span class="err">!</span> <span class="no">This</span> <span class="no">is</span> <span class="no">it</span><span class="err">!</span>
    <span class="nf">jmpi</span>    <span class="mi">0</span><span class="p">,</span><span class="mi">8</span>     <span class="err">!</span> <span class="no">jmp</span> <span class="no">offset</span> <span class="mi">0</span> <span class="no">of</span> <span class="no">segment</span> <span class="mi">8</span> <span class="p">(</span><span class="no">cs</span><span class="p">)</span>
</pre></div>


<h4>5. What is the meaning of 8 of the code <code>jmpi 0, 8</code> in the boot/setup.s?</h4>
<p>In 32-bit protected mode, the CS (Code Segment register) is used as code segment selector. The 8 (1000b) is the value of CS.</p>
<p>A segment selector is a 16-bit identifier for a segment. It does not point directly to the segment, but instead points to the segment descriptor that defines the segment. A segment selector contains the following items:</p>
<p><strong>Index</strong>
(Bits 3 throuth 15) -- Selects one of 8192 descriptors in the GDT or LDT.</p>
<p><strong>TI(table indicator) flag</strong>
(Bit 2) -- Specifies the descriptor table to use:clearing this flag selects the GDT; setting this flag selects the current LDT.</p>
<p><strong>Requested Privilege Level(RPL)</strong>
(Bits 0 and 1) -- Specifies the privilege level of the selector. The privilege level can range from 0 to 3, with 0 being the most privileged level.</p>
<p>Therefore, the 8 (1000b) means:</p>
<ul>
<li>Index is 1.</li>
<li>Selecting GDT.</li>
<li>RPL is 0</li>
</ul>
<p>The code <code>jmpi 0, 8</code> just indicates that we just jump to absolute address 0x00000000, in 32-bit protected mode.</p>
<h4>6. What is protected in the protected mode? Where does the protection work? What is the meaning and purpose of privilege level? Is the Paging able to provide protections?</h4>
<p>In protected mode, the IA-32 architectures provides a protections mechanism that operates at both the segment level and the page level.</p>
<p>This protection mechanism provides the ability to <code>limit access to certain segments or pges based on privilege levels</code>.</p>
<p>When the protection mechanism is used, each memory reference is checked to verify that it satisfies various protection checks. The protection checks that are performed fall into the following categories:</p>
<ul>
<li>Limit checks.</li>
<li>Type checks.</li>
<li>Privilege level checks.</li>
<li>Restriction of addressable domain.</li>
<li>Restriction of procedure entry-points.</li>
<li>Restriction of instruction set.</li>
</ul>
<p>All protection violtion results in an exception being generated.</p>
<p>There are four privilege levels for segments and two privilege levels of pages in protected mode. The protection mechanism wiil prevent the less privileged code from accessing the more privileged code and data in any but a contorlled, defined manner.</p>
<h4>7. GDT is set in setup. However, why is it discarded and set again in head? Why is it set twice instead of once?</h4>
<p>The GDT which is set in setup will be overwritten according to the memory layout of linux kernel (version 0.11). So you must set it again in head </p>
<h4>8. Where is the task_struct of Process 0? What is the content of it?</h4>
<p>I do <code>NOT</code> known where the task_struct of Process 0 is. But when I trace the linux kernel in my machine with bochs, I found it at the address 0x17280. Of course, it is meaningless.</p>
<p>The content of it is as follow:</p>
<div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  INIT_TASK is used to set up the first task table, touch at</span>
<span class="cm"> * your own risk!. Base=0, limit=0x9ffff (=640kB)</span>
<span class="cm"> */</span>
<span class="cp">#define INIT_TASK \</span>
<span class="cp">    </span><span class="cm">/* state etc */</span><span class="cp"> { 0,15,15, \</span>
<span class="cp">        </span><span class="cm">/* signals */</span><span class="cp">   0,{ { },},0, \</span>
<span class="cp">        </span><span class="cm">/* ec,brk... */</span><span class="cp"> 0,0,0,0,0,0, \</span>
<span class="cp">        </span><span class="cm">/* pid etc.. */</span><span class="cp"> 0,-1,0,0,0, \</span>
<span class="cp">        </span><span class="cm">/* uid etc */</span><span class="cp">   0,0,0,0,0,0, \</span>
<span class="cp">        </span><span class="cm">/* alarm */</span><span class="cp"> 0,0,0,0,0,0, \</span>
<span class="cp">        </span><span class="cm">/* math */</span><span class="cp">  0, \</span>
<span class="cp">        </span><span class="cm">/* fs info */</span><span class="cp">   -1,0022,NULL,NULL,NULL,0, \</span>
<span class="cp">        </span><span class="cm">/* filp */</span><span class="cp">  {NULL,}, \</span>
<span class="cp">        { \</span>
<span class="cp">            {0,0}, \</span>
<span class="cp">            </span><span class="cm">/* ldt */</span><span class="cp">   {0x9f,0xc0fa00}, \</span>
<span class="cp">            {0x9f,0xc0f200}, \</span>
<span class="cp">        }, \</span>
<span class="cp">        </span><span class="cm">/*tss*/</span><span class="cp"> {0,PAGE_SIZE+(long)&amp;init_task,0x10,0,0,0,0,(long)&amp;pg_dir,\</span>
<span class="cp">            0,0,0,0,0,0,0,0, \</span>
<span class="cp">            0,0,0x17,0x17,0x17,0x17,0x17,0x17, \</span>
<span class="cp">            _LDT(0),0x80000000, \</span>
<span class="cp">            {} \</span>
<span class="cp">        }, \</span>
<span class="cp">    }</span>
</pre></div>


<p>It might look like <a href="/assets/misc/task_struct.mem">this</a> in memory.</p>
<h4>9. Draw a picture describing the relationship between the first 7 pages after paging. Give some evidences(code).</h4>
<p>The following picture comes from the book -- The Art of Linux Kernel Design.</p>
<p><img alt="paging" src="/assets/images/paging.png" /></p>
<p>Paging code is as follow:</p>
<div class="highlight"><pre><span class="nl">setup_paging:</span>
    <span class="nf">movl</span> <span class="no">$1024</span><span class="p">*</span><span class="mi">5</span><span class="p">,</span><span class="nv">%ecx</span>       <span class="err">/</span><span class="p">*</span> <span class="mi">5</span> <span class="no">pages</span> <span class="p">-</span> <span class="no">pg_dir</span><span class="err">+</span><span class="mi">4</span> <span class="no">page</span> <span class="no">tables</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">xorl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">xorl</span> <span class="nv">%edi</span><span class="p">,</span><span class="nv">%edi</span>          <span class="err">/</span><span class="p">*</span> <span class="no">pg_dir</span> <span class="no">is</span> <span class="no">at</span> <span class="mi">0x000</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">cld</span><span class="err">;</span><span class="no">rep</span><span class="err">;</span><span class="no">stosl</span>
    <span class="nf">movl</span> <span class="no">$pg0</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span>     <span class="err">/</span><span class="p">*</span> <span class="no">set</span> <span class="no">present</span> <span class="no">bit</span><span class="err">/</span><span class="no">user</span> <span class="no">r</span><span class="err">/</span><span class="no">w</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg1</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span><span class="err">+</span><span class="mi">4</span>       <span class="err">/</span><span class="p">*</span>  <span class="p">---------</span> <span class="err">&quot;</span> <span class="err">&quot;</span> <span class="p">---------</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg2</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span><span class="err">+</span><span class="mi">8</span>       <span class="err">/</span><span class="p">*</span>  <span class="p">---------</span> <span class="err">&quot;</span> <span class="err">&quot;</span> <span class="p">---------</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg3</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span><span class="err">+</span><span class="mi">12</span>      <span class="err">/</span><span class="p">*</span>  <span class="p">---------</span> <span class="err">&quot;</span> <span class="err">&quot;</span> <span class="p">---------</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg3</span><span class="err">+</span><span class="mi">4092</span><span class="p">,</span><span class="nv">%edi</span>
    <span class="nf">movl</span> <span class="no">$0xfff007</span><span class="p">,</span><span class="nv">%eax</span>     <span class="err">/</span><span class="p">*</span>  <span class="mi">16</span><span class="no">Mb</span> <span class="p">-</span> <span class="mi">4096</span> <span class="err">+</span> <span class="mi">7</span> <span class="p">(</span><span class="no">r</span><span class="err">/</span><span class="no">w</span> <span class="no">user</span><span class="p">,</span><span class="no">p</span><span class="p">)</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">std</span>
<span class="err">1:</span>  <span class="nf">stosl</span>           <span class="err">/</span><span class="p">*</span> <span class="no">fill</span> <span class="no">pages</span> <span class="no">backwards</span> <span class="p">-</span> <span class="no">more</span> <span class="no">efficient</span> <span class="p">:-)</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">subl</span> <span class="no">$0x1000</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">jge</span> <span class="mi">1</span><span class="no">b</span>
    <span class="nf">xorl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%eax</span>      <span class="err">/</span><span class="p">*</span> <span class="no">pg_dir</span> <span class="no">is</span> <span class="no">at</span> <span class="mi">0x0000</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%cr3</span>      <span class="err">/</span><span class="p">*</span> <span class="no">cr3</span> <span class="p">-</span> <span class="no">page</span> <span class="no">directory</span> <span class="no">start</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="nv">%cr0</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">orl</span> <span class="no">$0x80000000</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">movl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%cr0</span>      <span class="err">/</span><span class="p">*</span> <span class="no">set</span> <span class="no">paging</span> <span class="p">(</span><span class="no">PG</span><span class="p">)</span> <span class="no">bit</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">ret</span>         <span class="err">/</span><span class="p">*</span> <span class="no">this</span> <span class="no">also</span> <span class="no">flushes</span> <span class="no">prefetch-queue</span> <span class="p">*</span><span class="err">/</span>
</pre></div>


<h4>10. What is the content of 184 bytes just before IDT after head finish executing? Why the code is left?</h4>
<p>The content is as follow:</p>
<div class="highlight"><pre><span class="nl">after_page_tables:</span>
    <span class="nf">pushl</span> <span class="no">$0</span>        <span class="c"># These are the parameters to main :-)</span>
    <span class="nf">pushl</span> <span class="no">$0</span>
    <span class="nf">pushl</span> <span class="no">$0</span>
    <span class="nf">pushl</span> <span class="no">$L6</span>       <span class="c"># return address for main, if it decides to.</span>
    <span class="nf">pushl</span> <span class="no">$_main</span>
    <span class="nf">jmp</span> <span class="no">setup_paging</span>
<span class="nl">L6:</span>
    <span class="nf">jmp</span> <span class="no">L6</span>          <span class="c"># main should never return here, but</span>
                <span class="c"># just in case, we know what happens.</span>

<span class="err">/*</span> <span class="nf">This</span> <span class="no">is</span> <span class="no">the</span> <span class="no">default</span> <span class="no">interrupt</span> <span class="err">&quot;</span><span class="no">handler</span><span class="err">&quot;</span> <span class="p">:-)</span> <span class="p">*</span><span class="err">/</span>
<span class="nl">int_msg:</span>
    <span class="na">.asciz</span> <span class="s">&quot;Unknown interrupt\n\r&quot;</span>
<span class="na">.align</span> <span class="mi">2</span>
<span class="nl">ignore_int:</span>
    <span class="nf">pushl</span> <span class="nv">%eax</span>
    <span class="nf">pushl</span> <span class="nv">%ecx</span>
    <span class="nf">pushl</span> <span class="nv">%edx</span>
    <span class="nf">push</span> <span class="nv">%ds</span>
    <span class="nf">push</span> <span class="nv">%es</span>
    <span class="nf">push</span> <span class="nv">%fs</span>
    <span class="nf">movl</span> <span class="no">$0x10</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">mov</span> <span class="nv">%ax</span><span class="p">,</span><span class="nv">%ds</span>
    <span class="nf">mov</span> <span class="nv">%ax</span><span class="p">,</span><span class="nv">%es</span>
    <span class="nf">mov</span> <span class="nv">%ax</span><span class="p">,</span><span class="nv">%fs</span>
    <span class="nf">pushl</span> <span class="no">$int_msg</span>
    <span class="nf">call</span> <span class="no">_printk</span>
    <span class="nf">popl</span> <span class="nv">%eax</span>
    <span class="nf">pop</span> <span class="nv">%fs</span>
    <span class="nf">pop</span> <span class="nv">%es</span>
    <span class="nf">pop</span> <span class="nv">%ds</span>
    <span class="nf">popl</span> <span class="nv">%edx</span>
    <span class="nf">popl</span> <span class="nv">%ecx</span>
    <span class="nf">popl</span> <span class="nv">%eax</span>
    <span class="nf">iret</span>

<span class="na">.align</span> <span class="mi">2</span>
<span class="nl">setup_paging:</span>
    <span class="nf">movl</span> <span class="no">$1024</span><span class="p">*</span><span class="mi">5</span><span class="p">,</span><span class="nv">%ecx</span>       <span class="err">/</span><span class="p">*</span> <span class="mi">5</span> <span class="no">pages</span> <span class="p">-</span> <span class="no">pg_dir</span><span class="err">+</span><span class="mi">4</span> <span class="no">page</span> <span class="no">tables</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">xorl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">xorl</span> <span class="nv">%edi</span><span class="p">,</span><span class="nv">%edi</span>          <span class="err">/</span><span class="p">*</span> <span class="no">pg_dir</span> <span class="no">is</span> <span class="no">at</span> <span class="mi">0x000</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">cld</span><span class="err">;</span><span class="no">rep</span><span class="err">;</span><span class="no">stosl</span>
    <span class="nf">movl</span> <span class="no">$pg0</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span>     <span class="err">/</span><span class="p">*</span> <span class="no">set</span> <span class="no">present</span> <span class="no">bit</span><span class="err">/</span><span class="no">user</span> <span class="no">r</span><span class="err">/</span><span class="no">w</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg1</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span><span class="err">+</span><span class="mi">4</span>       <span class="err">/</span><span class="p">*</span>  <span class="p">---------</span> <span class="err">&quot;</span> <span class="err">&quot;</span> <span class="p">---------</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg2</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span><span class="err">+</span><span class="mi">8</span>       <span class="err">/</span><span class="p">*</span>  <span class="p">---------</span> <span class="err">&quot;</span> <span class="err">&quot;</span> <span class="p">---------</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg3</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span><span class="err">+</span><span class="mi">12</span>      <span class="err">/</span><span class="p">*</span>  <span class="p">---------</span> <span class="err">&quot;</span> <span class="err">&quot;</span> <span class="p">---------</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg3</span><span class="err">+</span><span class="mi">4092</span><span class="p">,</span><span class="nv">%edi</span>
    <span class="nf">movl</span> <span class="no">$0xfff007</span><span class="p">,</span><span class="nv">%eax</span>     <span class="err">/</span><span class="p">*</span>  <span class="mi">16</span><span class="no">Mb</span> <span class="p">-</span> <span class="mi">4096</span> <span class="err">+</span> <span class="mi">7</span> <span class="p">(</span><span class="no">r</span><span class="err">/</span><span class="no">w</span> <span class="no">user</span><span class="p">,</span><span class="no">p</span><span class="p">)</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">std</span>
<span class="err">1:</span>  <span class="nf">stosl</span>           <span class="err">/</span><span class="p">*</span> <span class="no">fill</span> <span class="no">pages</span> <span class="no">backwards</span> <span class="p">-</span> <span class="no">more</span> <span class="no">efficient</span> <span class="p">:-)</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">subl</span> <span class="no">$0x1000</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">jge</span> <span class="mi">1</span><span class="no">b</span>
    <span class="nf">xorl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%eax</span>      <span class="err">/</span><span class="p">*</span> <span class="no">pg_dir</span> <span class="no">is</span> <span class="no">at</span> <span class="mi">0x0000</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%cr3</span>      <span class="err">/</span><span class="p">*</span> <span class="no">cr3</span> <span class="p">-</span> <span class="no">page</span> <span class="no">directory</span> <span class="no">start</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="nv">%cr0</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">orl</span> <span class="no">$0x80000000</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">movl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%cr0</span>      <span class="err">/</span><span class="p">*</span> <span class="no">set</span> <span class="no">paging</span> <span class="p">(</span><span class="no">PG</span><span class="p">)</span> <span class="no">bit</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">ret</span>         <span class="err">/</span><span class="p">*</span> <span class="no">this</span> <span class="no">also</span> <span class="no">flushes</span> <span class="no">prefetch-queue</span> <span class="p">*</span><span class="err">/</span>

<span class="na">.align</span> <span class="mi">2</span>
<span class="na">.word</span> <span class="mi">0</span>
<span class="nl">idt_descr:</span>
    <span class="na">.word</span> <span class="mi">256</span><span class="p">*</span><span class="mi">8</span><span class="p">-</span><span class="mi">1</span>       <span class="c"># idt contains 256 entries</span>
    <span class="na">.long</span> <span class="no">_idt</span>
<span class="na">.align</span> <span class="mi">2</span>
<span class="na">.word</span> <span class="mi">0</span>
<span class="nl">gdt_descr:</span>
    <span class="na">.word</span> <span class="mi">256</span><span class="p">*</span><span class="mi">8</span><span class="p">-</span><span class="mi">1</span>       <span class="c"># so does gdt (not that that is any</span>
    <span class="na">.long</span> <span class="no">_gdt</span>      <span class="c"># magic number, but it works for me :^)</span>
</pre></div>


<p>Obviously, the code left performs paging and turn the execution to main. It also contains some crucial data such as the initializer of IDTR and GDTR.</p>
<h4>11. Why execution is turned to main by 'ret'? Why not turn the execution by call? Draw a picture to describe it and give some evidences.</h4>
<p>It is a logical problem. If we use <code>call</code> here, we admin that something <code>call</code> to the OS. But there is nothing but the OS during the head execution. <code>ret</code> might solve the logical dilemma.</p>
<p>The code evidence is as follow:</p>
<div class="highlight"><pre><span class="nl">after_page_tables:</span>
    <span class="nf">pushl</span> <span class="no">$0</span>        <span class="c"># These are the parameters to main :-)</span>
    <span class="nf">pushl</span> <span class="no">$0</span>
    <span class="nf">pushl</span> <span class="no">$0</span>
    <span class="nf">pushl</span> <span class="no">$L6</span>       <span class="c"># return address for main, if it decides to.</span>
    <span class="nf">pushl</span> <span class="no">$_main</span>
    <span class="nf">jmp</span> <span class="no">setup_paging</span>
<span class="nl">L6:</span>
    <span class="nf">jmp</span> <span class="no">L6</span>          <span class="c"># main should never return here, but</span>
                <span class="c"># just in case, we know what happens.</span>

<span class="nl">setup_paging:</span>
    <span class="nf">movl</span> <span class="no">$1024</span><span class="p">*</span><span class="mi">5</span><span class="p">,</span><span class="nv">%ecx</span>       <span class="err">/</span><span class="p">*</span> <span class="mi">5</span> <span class="no">pages</span> <span class="p">-</span> <span class="no">pg_dir</span><span class="err">+</span><span class="mi">4</span> <span class="no">page</span> <span class="no">tables</span> <span class="p">*</span><span class="err">/</span>

    <span class="na">...</span>

    <span class="nf">ret</span>         <span class="err">/</span><span class="p">*</span> <span class="no">this</span> <span class="no">also</span> <span class="no">flushes</span> <span class="no">prefetch-queue</span> <span class="p">*</span><span class="err">/</span>
</pre></div>


<h4>12. Describe the initialization of Interrupt Descriptor Table. Give an example.</h4>
<p>In the <code>main</code> function, <code>trap_init</code> is called.</p>
<div class="highlight"><pre><span class="kt">void</span> <span class="nf">trap_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">set_trap_gate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">divide_error</span><span class="p">);</span>
    <span class="n">set_trap_gate</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">debug</span><span class="p">);</span>

    <span class="p">...</span>

    <span class="n">set_trap_gate</span><span class="p">(</span><span class="mi">39</span><span class="p">,</span><span class="o">&amp;</span><span class="n">parallel_interrupt</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p><code>set_trap_gate</code> and <code>_set_gate</code> is as follow:</p>
<div class="highlight"><pre><span class="c">#define set_trap_gate(n,addr) \                                                                                                 </span>
<span class="nf">_set_gate</span><span class="p">(</span><span class="err">&amp;</span><span class="no">idt</span><span class="err">[</span><span class="no">n</span><span class="err">]</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="no">addr</span><span class="p">)</span>

<span class="c">#define _set_gate(gate_addr,type,dpl,addr) \                                                                                   </span>
    <span class="nf">__asm__</span> <span class="p">(</span><span class="err">&quot;</span><span class="no">movw</span> <span class="err">%</span><span class="nv">%dx</span><span class="p">,</span><span class="err">%</span><span class="nv">%ax</span><span class="err">\</span><span class="no">n</span><span class="err">\</span><span class="no">t</span><span class="err">&quot;</span> <span class="err">\</span>
            <span class="err">&quot;</span><span class="nf">movw</span> <span class="err">%</span><span class="mi">0</span><span class="p">,</span><span class="err">%</span><span class="nv">%dx</span><span class="err">\</span><span class="no">n</span><span class="err">\</span><span class="no">t</span><span class="err">&quot;</span> <span class="err">\</span>
            <span class="err">&quot;</span><span class="nf">movl</span> <span class="err">%</span><span class="nv">%eax</span><span class="p">,</span><span class="err">%</span><span class="mi">1</span><span class="err">\</span><span class="no">n</span><span class="err">\</span><span class="no">t</span><span class="err">&quot;</span> <span class="err">\</span>
            <span class="err">&quot;</span><span class="nf">movl</span> <span class="err">%</span><span class="nv">%edx</span><span class="p">,</span><span class="err">%</span><span class="mi">2</span><span class="err">&quot;</span> <span class="err">\</span>
            <span class="err">:</span> <span class="err">\</span>
            <span class="err">:</span> <span class="err">&quot;</span><span class="nf">i</span><span class="err">&quot;</span> <span class="p">((</span><span class="no">short</span><span class="p">)</span> <span class="p">(</span><span class="mi">0x8000</span><span class="err">+</span><span class="p">(</span><span class="no">dpl</span><span class="err">&lt;&lt;</span><span class="mi">13</span><span class="p">)</span><span class="err">+</span><span class="p">(</span><span class="no">type</span><span class="err">&lt;&lt;</span><span class="mi">8</span><span class="p">))),</span> <span class="err">\</span>
            <span class="err">&quot;</span><span class="nf">o</span><span class="err">&quot;</span> <span class="p">(*((</span><span class="no">char</span> <span class="p">*)</span> <span class="p">(</span><span class="no">gate_addr</span><span class="p">))),</span> <span class="err">\</span>
            <span class="err">&quot;</span><span class="nf">o</span><span class="err">&quot;</span> <span class="p">(*(</span><span class="mi">4</span><span class="err">+</span><span class="p">(</span><span class="no">char</span> <span class="p">*)</span> <span class="p">(</span><span class="no">gate_addr</span><span class="p">))),</span> <span class="err">\</span>
            <span class="err">&quot;</span><span class="nf">d</span><span class="err">&quot;</span> <span class="p">((</span><span class="no">char</span> <span class="p">*)</span> <span class="p">(</span><span class="no">addr</span><span class="p">)),</span><span class="err">&quot;</span><span class="no">a</span><span class="err">&quot;</span> <span class="p">(</span><span class="mi">0x00080000</span><span class="p">))</span>
</pre></div>


<h4>13. There are more than 20 instructions can be only executed in Privilege 0 in the IA-32 architectures. However, other instructions like 'cli' is not one of them. Why does the process with Priviledge 3 cannot execute it in linux 0.11?</h4>
<p>The instructions <code>cli</code> and <code>sti</code> are under control of IOPL (Input/Output Privilege Level), which resdes in eflags. When the IOPL field is 0, the process with Privilege 3 cannnot execute them.</p>
<p>The code evidence is as follow:</p>
<div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  INIT_TASK is used to set up the first task table, touch at</span>
<span class="cm"> * your own risk!. Base=0, limit=0x9ffff (=640kB)</span>
<span class="cm"> */</span>
<span class="cp">#define INIT_TASK \</span>
<span class="cp">    </span><span class="cm">/* state etc */</span><span class="cp"> { 0,15,15, \</span>
<span class="cp">        </span><span class="cm">/* signals */</span><span class="cp">   0,{ { },},0, \</span>
<span class="cp">        </span><span class="cm">/* ec,brk... */</span><span class="cp"> 0,0,0,0,0,0, \</span>
<span class="cp">        </span><span class="cm">/* pid etc.. */</span><span class="cp"> 0,-1,0,0,0, \</span>
<span class="cp">        </span><span class="cm">/* uid etc */</span><span class="cp">   0,0,0,0,0,0, \</span>
<span class="cp">        </span><span class="cm">/* alarm */</span><span class="cp"> 0,0,0,0,0,0, \</span>
<span class="cp">        </span><span class="cm">/* math */</span><span class="cp">  0, \</span>
<span class="cp">        </span><span class="cm">/* fs info */</span><span class="cp">   -1,0022,NULL,NULL,NULL,0, \</span>
<span class="cp">        </span><span class="cm">/* filp */</span><span class="cp">  {NULL,}, \</span>
<span class="cp">        { \</span>
<span class="cp">            {0,0}, \</span>
<span class="cp">            </span><span class="cm">/* ldt */</span><span class="cp">   {0x9f,0xc0fa00}, \</span>
<span class="cp">            {0x9f,0xc0f200}, \</span>
<span class="cp">        }, \</span>
<span class="cp">        </span><span class="cm">/*tss*/</span><span class="cp"> {0,PAGE_SIZE+(long)&amp;init_task,0x10,0,0,0,0,(long)&amp;pg_dir,\</span>
<span class="cp">            0,0</span><span class="cm">/* eflags */</span><span class="cp">,0,0,0,0,0,0, \</span>
<span class="cp">            0,0,0x17,0x17,0x17,0x17,0x17,0x17, \</span>
<span class="cp">            _LDT(0),0x80000000, \</span>
<span class="cp">            {} \</span>
<span class="cp">        }, \</span>
<span class="cp">    }</span>
</pre></div>


<p>The task sturct of process 0 is initialized with <code>INIT_TASK</code>. Obviously, the <code>eflags.IOPL</code> is 0. The task structs of other processes are copy of <code>INIT_TASK</code> with no changing <code>eflags.IOPL</code>.</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="nf">copy_process</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span><span class="kt">long</span> <span class="n">ebp</span><span class="p">,</span><span class="kt">long</span> <span class="n">edi</span><span class="p">,</span><span class="kt">long</span> <span class="n">esi</span><span class="p">,</span><span class="kt">long</span> <span class="n">gs</span><span class="p">,</span><span class="kt">long</span> <span class="n">none</span><span class="p">,</span>
        <span class="kt">long</span> <span class="n">ebx</span><span class="p">,</span><span class="kt">long</span> <span class="n">ecx</span><span class="p">,</span><span class="kt">long</span> <span class="n">edx</span><span class="p">,</span>
        <span class="kt">long</span> <span class="n">fs</span><span class="p">,</span><span class="kt">long</span> <span class="n">es</span><span class="p">,</span><span class="kt">long</span> <span class="n">ds</span><span class="p">,</span> 
        <span class="kt">long</span> <span class="n">eip</span><span class="p">,</span><span class="kt">long</span> <span class="n">cs</span><span class="p">,</span><span class="kt">long</span> <span class="n">eflags</span><span class="p">,</span><span class="kt">long</span> <span class="n">esp</span><span class="p">,</span><span class="kt">long</span> <span class="n">ss</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> 
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span> 

    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_free_page</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
    <span class="n">task</span><span class="p">[</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">current</span><span class="p">;</span>  <span class="cm">/* NOTE! this doesn&#39;t copy the supervisor stack */</span>

    <span class="p">...</span>

    <span class="n">p</span><span class="o">-&gt;</span><span class="n">tss</span><span class="p">.</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">eflags</span><span class="p">;</span>

    <span class="p">...</span>

<span class="p">}</span>
</pre></div>


<h4>14. It is the same as question 8.</h4>
<h4>15. Interrupt gate, trap gate and system call are set throuth _set_gate function. The difference between them is that the DPL of system call gate is 3, but the DPL of the other two is 0. Try to explain it.</h4>
<p>When the DPL of a gate is 0, the gate can only be called by the processes with privilege 0, such as kernel.</p>
<p>When the DPL of a gate is 3, the gate can be called by the processes with privilege 3, such as user application.</p>
<p>Usually, the interrupt gate and trap gate are critical system function, which should be executed only by kernel.</p>
<p>However, the system call is designed for the user applications to use the functions provided by OS.</p>
<h4>16. Why the Process 0 calls the 'move_to_user_mode()' bofore forking the Process 1? How does the function work? Try to explain it.</h4>
<blockquote>
<p>In Linux, all the processes expect Process 0 should be created by an existing process running in the Privilege 3.
The Process 0 is designed by OS designers and is running in Privilege 0 before <code>move_to_user_mode()</code>.
In order to conform the standards, Process 0 should call <code>move_to_user_mode</code> to change the current privilege level before forking the Process 1.</p>
</blockquote>
<p>The explanation above is given by <code>The Art of Linux Kernel Design</code>. But it seems unreasonable.</p>
<p>According to my best knowledge, if the privilege level does not change after call gate, the stack will not be switched.This might cause unexpected results. Stack switching during an interprivilege-level call should be the root cause.</p>
<p>The function <code>move_to_user_mode</code> imitate what the hardware do when an interrupt occurs.
Firstly, <code>SS</code>, <code>ESP</code>, <code>EFLAGS</code>, <code>CS</code> and <code>EIP</code> will be pushed into the current stack.
Then, the instruction <code>iret</code> will be executed.  The hardware will do what it does while returning from a call gate, such as poping the registers to corresponding one.</p>
<p>The code is as follow:</p>
<div class="highlight"><pre><span class="cp">#define move_to_user_mode() \                                                                                                                </span>
<span class="n">__asm__</span> <span class="p">(</span><span class="s">&quot;movl %%esp,%%eax</span><span class="se">\n\t</span><span class="s">&quot;</span> \
        <span class="s">&quot;pushl $0x17</span><span class="se">\n\t</span><span class="s">&quot;</span> \
        <span class="s">&quot;pushl %%eax</span><span class="se">\n\t</span><span class="s">&quot;</span> \
        <span class="s">&quot;pushfl</span><span class="se">\n\t</span><span class="s">&quot;</span> \
        <span class="s">&quot;pushl $0x0f</span><span class="se">\n\t</span><span class="s">&quot;</span> \
        <span class="s">&quot;pushl $1f</span><span class="se">\n\t</span><span class="s">&quot;</span> \
        <span class="s">&quot;iret</span><span class="se">\n</span><span class="s">&quot;</span> \
        <span class="s">&quot;1:</span><span class="se">\t</span><span class="s">movl $0x17,%%eax</span><span class="se">\n\t</span><span class="s">&quot;</span> \
        <span class="s">&quot;movw %%ax,%%ds</span><span class="se">\n\t</span><span class="s">&quot;</span> \
        <span class="s">&quot;movw %%ax,%%es</span><span class="se">\n\t</span><span class="s">&quot;</span> \
        <span class="s">&quot;movw %%ax,%%fs</span><span class="se">\n\t</span><span class="s">&quot;</span> \
        <span class="s">&quot;movw %%ax,%%gs&quot;</span> \
        <span class="o">:::</span><span class="s">&quot;ax&quot;</span><span class="p">)</span>
</pre></div>


<p>The <code>0x17</code> in the code above indicates Privilege 3, LDT and Data Segment.
The <code>0x0f</code> in the code above indicates Privilege 3, LDT and Code Segment.</p>
<h4>17. Interrupt and exception are used widely in linux. What is the benefit?</h4>
<p>Imporve the efficiency of CPU? (In fact, I do no really understand the question.)</p>
<h4>18. The last five parameters of copy_process are 'long eip, long cs, long eflags, long esp, long ss', which reside in the stack when calling it. But there is no code about pushing the five arguments into the stack. Try to explain it.</h4>
<p>The five arguments are pushed into stack by hardware when it executes the instruction <code>int 80</code>.</p>
<h4>19. Analyse the function 'get_free_page' and give an introduction.</h4>
<p>The code is as follow:</p>
<div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Get physical address of first (actually last :-) free page, and mark it</span>
<span class="cm"> * used. If no free pages left, return 0.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">get_free_page</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">register</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__res</span> <span class="n">asm</span><span class="p">(</span><span class="s">&quot;ax&quot;</span><span class="p">);</span>

    <span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;std ; repne ; scasb</span><span class="se">\n\t</span><span class="s">&quot;</span>
            <span class="s">&quot;jne 1f</span><span class="se">\n\t</span><span class="s">&quot;</span>
            <span class="s">&quot;movb $1,1(%%edi)</span><span class="se">\n\t</span><span class="s">&quot;</span>
            <span class="s">&quot;sall $12,%%ecx</span><span class="se">\n\t</span><span class="s">&quot;</span>
            <span class="s">&quot;addl %2,%%ecx</span><span class="se">\n\t</span><span class="s">&quot;</span>
            <span class="s">&quot;movl %%ecx,%%edx</span><span class="se">\n\t</span><span class="s">&quot;</span>
            <span class="s">&quot;movl $1024,%%ecx</span><span class="se">\n\t</span><span class="s">&quot;</span>
            <span class="s">&quot;leal 4092(%%edx),%%edi</span><span class="se">\n\t</span><span class="s">&quot;</span>
            <span class="s">&quot;rep ; stosl</span><span class="se">\n\t</span><span class="s">&quot;</span>
            <span class="s">&quot;movl %%edx,%%eax</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="s">&quot;1:&quot;</span>
            <span class="o">:</span><span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">__res</span><span class="p">)</span>
            <span class="o">:</span><span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="s">&quot;i&quot;</span> <span class="p">(</span><span class="n">LOW_MEM</span><span class="p">),</span><span class="s">&quot;c&quot;</span> <span class="p">(</span><span class="n">PAGING_PAGES</span><span class="p">),</span>
            <span class="s">&quot;D&quot;</span> <span class="p">(</span><span class="n">mem_map</span><span class="o">+</span><span class="n">PAGING_PAGES</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="o">:</span><span class="s">&quot;di&quot;</span><span class="p">,</span><span class="s">&quot;cx&quot;</span><span class="p">,</span><span class="s">&quot;dx&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">__res</span><span class="p">;</span>                                                                                                                                         
<span class="p">}</span>
</pre></div>


<p>In linux 0.11, <code>mem_map</code> is a table which keeps the usage of physical address.
Firstly, The code above scan <code>mem_map</code> backward and find the first free page, whoes value in the <code>mem_map</code> is 0.
Then, mark it used by changing its value to 1 and clear the free page.
Finally, return the address of the free page.
If no free pages left, return 0.</p>
<h4>20. Analyse the function 'copy_page_tables' and give an introduction.</h4>
<p>The code is as follow:</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="nf">copy_page_tables</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">from</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">to</span><span class="p">,</span><span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span> <span class="n">from_page_table</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span> <span class="n">to_page_table</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">this_page</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span> <span class="n">from_dir</span><span class="p">,</span> <span class="o">*</span> <span class="n">to_dir</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">from</span><span class="o">&amp;</span><span class="mh">0x3fffff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">to</span><span class="o">&amp;</span><span class="mh">0x3fffff</span><span class="p">))</span>
        <span class="n">panic</span><span class="p">(</span><span class="s">&quot;copy_page_tables called with wrong alignment&quot;</span><span class="p">);</span>
    <span class="n">from_dir</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">from</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffc</span><span class="p">);</span> <span class="cm">/* _pg_dir = 0 */</span>
    <span class="n">to_dir</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">to</span><span class="o">&gt;&gt;</span><span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffc</span><span class="p">);</span>
    <span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span><span class="o">+</span><span class="mh">0x3fffff</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span> <span class="p">;</span> <span class="n">size</span><span class="o">--&gt;</span><span class="mi">0</span> <span class="p">;</span> <span class="n">from_dir</span><span class="o">++</span><span class="p">,</span><span class="n">to_dir</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">to_dir</span><span class="p">)</span>
            <span class="n">panic</span><span class="p">(</span><span class="s">&quot;copy_page_tables: already exist&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">from_dir</span><span class="p">))</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="n">from_page_table</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="mh">0xfffff000</span> <span class="o">&amp;</span> <span class="o">*</span><span class="n">from_dir</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">to_page_table</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_free_page</span><span class="p">()))</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Out of memory, see freeing */</span>
        <span class="o">*</span><span class="n">to_dir</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">to_page_table</span><span class="p">)</span> <span class="o">|</span> <span class="mi">7</span><span class="p">;</span>
        <span class="n">nr</span> <span class="o">=</span> <span class="p">(</span><span class="n">from</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="mh">0xA0</span><span class="o">:</span><span class="mi">1024</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">nr</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">from_page_table</span><span class="o">++</span><span class="p">,</span><span class="n">to_page_table</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">this_page</span> <span class="o">=</span> <span class="o">*</span><span class="n">from_page_table</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="n">this_page</span><span class="p">))</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="n">this_page</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
            <span class="o">*</span><span class="n">to_page_table</span> <span class="o">=</span> <span class="n">this_page</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">this_page</span> <span class="o">&gt;</span> <span class="n">LOW_MEM</span><span class="p">)</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">from_page_table</span> <span class="o">=</span> <span class="n">this_page</span><span class="p">;</span>
                <span class="n">this_page</span> <span class="o">-=</span> <span class="n">LOW_MEM</span><span class="p">;</span>
                <span class="n">this_page</span> <span class="o">&gt;&gt;=</span> <span class="mi">12</span><span class="p">;</span>
                <span class="n">mem_map</span><span class="p">[</span><span class="n">this_page</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">invalidate</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>The answer is no very difficult but very complicated. Maybe I will finish it someday.</p>
<h4>21. When Process 0 creates Process 1, Process allocate a page for Process 1 for task_struct as well as Privilege 0 stack and the first page table respectively. Whose linear address space does the two pages reside, Kernel, Process 0, Process 1 or nothing?</h4>
<p>The two pages reside in the linear address space of Kernel.</p>
<p>The code evidence is as follow:</p>
<p>Setup paging and allocate pages in linear address space of Kernel.</p>
<div class="highlight"><pre><span class="nl">setup_paging:</span>
    <span class="nf">movl</span> <span class="no">$1024</span><span class="p">*</span><span class="mi">5</span><span class="p">,</span><span class="nv">%ecx</span>       <span class="err">/</span><span class="p">*</span> <span class="mi">5</span> <span class="no">pages</span> <span class="p">-</span> <span class="no">pg_dir</span><span class="err">+</span><span class="mi">4</span> <span class="no">page</span> <span class="no">tables</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">xorl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">xorl</span> <span class="nv">%edi</span><span class="p">,</span><span class="nv">%edi</span>          <span class="err">/</span><span class="p">*</span> <span class="no">pg_dir</span> <span class="no">is</span> <span class="no">at</span> <span class="mi">0x000</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">cld</span><span class="err">;</span><span class="no">rep</span><span class="err">;</span><span class="no">stosl</span>
    <span class="nf">movl</span> <span class="no">$pg0</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span>     <span class="err">/</span><span class="p">*</span> <span class="no">set</span> <span class="no">present</span> <span class="no">bit</span><span class="err">/</span><span class="no">user</span> <span class="no">r</span><span class="err">/</span><span class="no">w</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg1</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span><span class="err">+</span><span class="mi">4</span>       <span class="err">/</span><span class="p">*</span>  <span class="p">---------</span> <span class="err">&quot;</span> <span class="err">&quot;</span> <span class="p">---------</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg2</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span><span class="err">+</span><span class="mi">8</span>       <span class="err">/</span><span class="p">*</span>  <span class="p">---------</span> <span class="err">&quot;</span> <span class="err">&quot;</span> <span class="p">---------</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg3</span><span class="err">+</span><span class="mi">7</span><span class="p">,</span><span class="no">_pg_dir</span><span class="err">+</span><span class="mi">12</span>      <span class="err">/</span><span class="p">*</span>  <span class="p">---------</span> <span class="err">&quot;</span> <span class="err">&quot;</span> <span class="p">---------</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="no">$pg3</span><span class="err">+</span><span class="mi">4092</span><span class="p">,</span><span class="nv">%edi</span>
    <span class="nf">movl</span> <span class="no">$0xfff007</span><span class="p">,</span><span class="nv">%eax</span>     <span class="err">/</span><span class="p">*</span>  <span class="mi">16</span><span class="no">Mb</span> <span class="p">-</span> <span class="mi">4096</span> <span class="err">+</span> <span class="mi">7</span> <span class="p">(</span><span class="no">r</span><span class="err">/</span><span class="no">w</span> <span class="no">user</span><span class="p">,</span><span class="no">p</span><span class="p">)</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">std</span>
<span class="err">1:</span>  <span class="nf">stosl</span>           <span class="err">/</span><span class="p">*</span> <span class="no">fill</span> <span class="no">pages</span> <span class="no">backwards</span> <span class="p">-</span> <span class="no">more</span> <span class="no">efficient</span> <span class="p">:-)</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">subl</span> <span class="no">$0x1000</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">jge</span> <span class="mi">1</span><span class="no">b</span>
    <span class="nf">xorl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%eax</span>      <span class="err">/</span><span class="p">*</span> <span class="no">pg_dir</span> <span class="no">is</span> <span class="no">at</span> <span class="mi">0x0000</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%cr3</span>      <span class="err">/</span><span class="p">*</span> <span class="no">cr3</span> <span class="p">-</span> <span class="no">page</span> <span class="no">directory</span> <span class="no">start</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">movl</span> <span class="nv">%cr0</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">orl</span> <span class="no">$0x80000000</span><span class="p">,</span><span class="nv">%eax</span>
    <span class="nf">movl</span> <span class="nv">%eax</span><span class="p">,</span><span class="nv">%cr0</span>      <span class="err">/</span><span class="p">*</span> <span class="no">set</span> <span class="no">paging</span> <span class="p">(</span><span class="no">PG</span><span class="p">)</span> <span class="no">bit</span> <span class="p">*</span><span class="err">/</span>
    <span class="nf">ret</span>         <span class="err">/</span><span class="p">*</span> <span class="no">this</span> <span class="no">also</span> <span class="no">flushes</span> <span class="no">prefetch-queue</span> <span class="p">*</span><span class="err">/</span>
</pre></div>


<p>Allocate a page for task_struct and Privilege 0 stack</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="nf">copy_process</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span><span class="kt">long</span> <span class="n">ebp</span><span class="p">,</span><span class="kt">long</span> <span class="n">edi</span><span class="p">,</span><span class="kt">long</span> <span class="n">esi</span><span class="p">,</span><span class="kt">long</span> <span class="n">gs</span><span class="p">,</span><span class="kt">long</span> <span class="n">none</span><span class="p">,</span>
        <span class="kt">long</span> <span class="n">ebx</span><span class="p">,</span><span class="kt">long</span> <span class="n">ecx</span><span class="p">,</span><span class="kt">long</span> <span class="n">edx</span><span class="p">,</span>
        <span class="kt">long</span> <span class="n">fs</span><span class="p">,</span><span class="kt">long</span> <span class="n">es</span><span class="p">,</span><span class="kt">long</span> <span class="n">ds</span><span class="p">,</span> 
        <span class="kt">long</span> <span class="n">eip</span><span class="p">,</span><span class="kt">long</span> <span class="n">cs</span><span class="p">,</span><span class="kt">long</span> <span class="n">eflags</span><span class="p">,</span><span class="kt">long</span> <span class="n">esp</span><span class="p">,</span><span class="kt">long</span> <span class="n">ss</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> 
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span> 

    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_free_page</span><span class="p">();</span>

    <span class="p">...</span>

<span class="p">}</span>
</pre></div>


<p>Allocate pages for page tables</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="nf">copy_page_tables</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">from</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">to</span><span class="p">,</span><span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>

    <span class="k">for</span><span class="p">(</span> <span class="p">;</span> <span class="n">size</span><span class="o">--&gt;</span><span class="mi">0</span> <span class="p">;</span> <span class="n">from_dir</span><span class="o">++</span><span class="p">,</span><span class="n">to_dir</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="p">...</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">to_page_table</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_free_page</span><span class="p">()))</span>    

        <span class="p">...</span>

    <span class="p">}</span>

    <span class="p">...</span>

<span class="p">}</span>
</pre></div>


<h4>22. Similar to question 21.</h4>
<h4>23. Explain the code 'ljmp %0' in the function 'switch_to'.</h4>
<p>The code is as follow:</p>
<div class="highlight"><pre><span class="cp">#define switch_to(n) {\</span>
<span class="cp">    struct {long a,b;} __tmp; \</span>
<span class="cp">        __asm__(&quot;cmpl %%ecx,_current\n\t&quot; \</span>
<span class="cp">                &quot;je 1f\n\t&quot; \</span>
<span class="cp">                &quot;movw %%dx,%1\n\t&quot; \</span>
<span class="cp">                &quot;xchgl %%ecx,_current\n\t&quot; \</span>
<span class="cp">                &quot;ljmp %0\n\t&quot; \</span>
<span class="cp">                &quot;cmpl %%ecx,_last_task_used_math\n\t&quot; \</span>
<span class="cp">                &quot;jne 1f\n\t&quot; \</span>
<span class="cp">                &quot;clts\n&quot; \</span>
<span class="cp">                &quot;1:&quot; \</span>
<span class="cp">                ::&quot;m&quot; (*&amp;__tmp.a),&quot;m&quot; (*&amp;__tmp.b), \</span>
<span class="cp">                &quot;d&quot; (_TSS(n)),&quot;c&quot; ((long) task[n])); \</span>
<span class="cp">}</span>
</pre></div>


<p>The instruction <code>ljmp *mem48</code> can use the high 2 bytes as CS and the low 4 bytes as EIP pointed by mem48.
Well, <code>__tmp.b</code> is initialized with <code>_TSS(n)</code>, which is owned by the Process n.
<code>ljmp to a TSS</code> means task switching.</p>
<h4>24. Process 0 creates Process 1 through the function 'fork();', but it is executed twice. Try to explain it.</h4>
<p>Process 0 creates Process 1 throuth the function <code>fork()</code>. During the time, Process 0 set the <code>EIP</code> of Process 1 with the address of the next instruction after <code>int 0x80</code>.
And the Process 0 and Process 1 share the same code.When transferring program control to the Porcess 1, it just executes the instruction pointed by <code>CS:EIP</code>.
Therefore, the funtion <code>fork()</code> seems to be executed twice. In fact, the Process 0 executes the whole of function <code>fork()</code> while the Process 1 executes the rest of function <code>fork()</code>, which is the part from <code>int 0x80</code> to the end.</p>
<h3>Reference</h3>
<p>[1] The Art of Linux Kernel Design, Second Edition.</p>
<p>[2] <a href="http://www.intel.com/content/www/us/en/processors/architectures-software-developer-manuals.html?iid=tech_vt_tech+64-32_manuals">IA-32 Architectures Software Developer vol-3a-part-1 Manual</a></p>
<p>[3] <a href="https://www.wikipedia.org/">Wikipedia</a></p>
<p>[4] <a href="http://docs.oracle.com/cd/E19455-01/806-3773/instructionset-73/index.html">IA-32 Assembly Language Reference Manual</a></p></div>
	
        <hr>

        <h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'blxg'; 
    var disqus_title = 'Several Problems about Linux Kernel';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <li><a href="./archives.html">Archives</a>
                <li><a href="./tags.html">Tags</a>



                <li><a href="http://gotit.sinaapp.com/feeds/all.atom.xml" rel="alternate">Atom feed</a></li>

            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                <li><a href="./category/ccpp.html">C/CPP</a></li>
                <li><a href="./category/linux.html">linux</a></li>
                <li><a href="./category/security.html">Security</a></li>
                   
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Links
                </li>
            
                <li><a href="http://getpelican.com/">Pelican</a></li>
                <li><a href="http://python.org/">Python.org</a></li>
                <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
            </ul>
            </div>


            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                <li><a href="https://github.com/buptlxb">Github</a></li>
                <li><a href="http://weibo.com/ictlxb">Weibo</a></li>
            </ul>
            </div>


            <div class="tagcloud">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="tagcloud">
                <li class="tag-4"><a href="./tag/constructor.html">constructor</a></li>
                <li class="tag-4"><a href="./tag/optimization.html">optimization</a></li>
                <li class="tag-4"><a href="./tag/inheritance.html">inheritance</a></li>
                <li class="tag-2"><a href="./tag/security.html">Security</a></li>
                <li class="tag-1"><a href="./tag/os.html">os</a></li>
                <li class="tag-4"><a href="./tag/linxu.html">linxu</a></li>
                <li class="tag-4"><a href="./tag/contructor.html">contructor</a></li>
                <li class="tag-4"><a href="./tag/ccpp.html">C/CPP</a></li>
                <li class="tag-3"><a href="./tag/network.html">Network</a></li>
                <li class="tag-4"><a href="./tag/row-major.html">row-major</a></li>
                <li class="tag-1"><a href="./tag/bochs.html">bochs</a></li>
                <li class="tag-4"><a href="./tag/array.html">array</a></li>
                <li class="tag-4"><a href="./tag/vpn.html">vpn</a></li>
                <li class="tag-3"><a href="./tag/ubuntu.html">Ubuntu</a></li>
                <li class="tag-1"><a href="./tag/linux.html">linux</a></li>
                <li class="tag-4"><a href="./tag/cpp.html">cpp</a></li>
                <li class="tag-4"><a href="./tag/cache-miss.html">cache miss</a></li>
            </ul>
            </div>

            </div>


        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href=".">BLxG</a> &copy; ictlxb 2015</p>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="./theme/bootstrap-collapse.js"></script>
 
</body>
</html>