<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>BLxG</title>
    <meta name="author" content="ictlxb">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta property="wb:webmaster" content="35e06a32947da88a" />

    <meta name="description" content="Programming and Life -- http://www.gotit.sinaapp.com">
    <meta name="keywords" content="算法,软件开发,Algorithm,C++,Coding,Debug,Google,Linux,,OS,,Programmer,programming,language,Python,Ubuntu,Unix,vim">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="../theme/html5.js"></script>
    <![endif]-->
    <link rel="shortcut icon" href="../theme/images/icons/favicon.ico"/>
    <link rel="bookmark" href="../theme/images/icons/favicon.ico"/>
    <!-- Le styles -->
    <link href="../theme/bootstrap.min.css" rel="stylesheet">
    <link href="../theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="../theme/local.css" rel="stylesheet">
    <link href="../theme/pygments.css" rel="stylesheet">

    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="http://gotit.applinzi.com/feeds/all.atom.xml" rel="alternate" title="BLxG" type="application/atom+xml">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="..">BLxG</a>

        <div class="nav-collapse">
        <ul class="nav">
            
            <li><a href="../pages/about.html">About</a></li>
        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
        

        


    <div class='article'>
        <div class="content-title">
            <a href="../program-optimization-experiments.html"><h1>Program Optimization Experiments</h1></a>
六 03 五月 2014

by <a class="url fn" href="../author/ictlxb.html">ictlxb</a>
 

Filed under <a href="../category/ccpp.html">C/CPP</a>

 
    Tags <a href="../tag/optimization.html">optimization</a> <a href="../tag/cache-miss.html">cache miss</a> <a href="../tag/row-major.html">row-major</a>  
        </div>
        
        <div><blockquote>
<p>Program optimization is a very intresting problem. With the different matrix-multiply
program, I want to find the factors which might have influence on the
performace of the programs. Several experiments has been conducted on my
computer. Source code and results will be listed as follow. Also, I will give a
brief analysis and some simple conclusions on them.
Machine Information can be found <a href="/assets/misc/info.pdf">here</a></p>
</blockquote>
<h3>1 There Loops Resolution</h3>
<h4>1.1 Source Code</h4>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp"></span>

<span class="cp">#define DIM 4096</span>
<span class="k">typedef</span> <span class="nf">double</span><span class="p">(</span><span class="o">*</span> <span class="n">MATRIX</span><span class="p">)[</span><span class="n">DIM</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">z</span><span class="p">,</span> <span class="k">const</span> <span class="n">MATRIX</span> <span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="n">MATRIX</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">col</span><span class="p">];</span>
            <span class="n">z</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init_matrix</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isRandom</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isRandom</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">srandom</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span>
                <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">263</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_matrix</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%f &quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MATRIX</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">MATRIX</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">MATRIX</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">multiply</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">DIM</span><span class="p">);</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">DIM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">opts</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">time</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d matrix multiply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DIM</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;time : %ds</span><span class="se">\t</span><span class="s">speed: %.2f MFLOPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h4>1.2 Results</h4>
<h5>1.2.1 No Optimization</h5>
<div class="highlight"><pre><span></span>ict-lxb@ictlxb-Zhaoyang-E49:~/Workspace/test$ ./matrix
<span class="m">4096</span> matrix multiply
<span class="nb">time</span> : 1038s    speed: 132.39 MFLOPS
</pre></div>


<h5>1.2.2 -O2 Optimization</h5>
<div class="highlight"><pre><span></span>ict-lxb@ictlxb-Zhaoyang-E49:~/Workspace/test$ ./matrix_O2 
<span class="m">4096</span> matrix multiply
<span class="nb">time</span> : 944s speed: 145.57 MFLOPS
</pre></div>


<h4>1.3 Conclusion</h4>
<p>After analysing the results above, we can see that the same source code
compiled with different optimization options might result in very different
performance. The compiler can improve the performance by reordering the
instructions, which might cause bubble in the instruction parallel, and so
on.</p>
<h3>2 Three Loops Resulotion (4097X4097)</h3>
<h4>2.1 Source Code</h4>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp"></span>

<span class="cp">#define DIM 4097</span>
<span class="k">typedef</span> <span class="nf">double</span><span class="p">(</span><span class="o">*</span> <span class="n">MATRIX</span><span class="p">)[</span><span class="n">DIM</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">z</span><span class="p">,</span> <span class="k">const</span> <span class="n">MATRIX</span> <span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="n">MATRIX</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">col</span><span class="p">];</span>
            <span class="n">z</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init_matrix</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isRandom</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isRandom</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">srandom</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span>
                <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">263</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_matrix</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%f &quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MATRIX</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">MATRIX</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">MATRIX</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">multiply</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">DIM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
    <span class="c1">//unsigned long long opts = (unsigned long long)DIM*DIM*(2*DIM-1);</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">DIM</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">n</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">opts</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">time</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d matrix multiply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DIM</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;time : %ds</span><span class="se">\t</span><span class="s">speed: %.2f MFLOPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h4>2.2 Results</h4>
<div class="highlight"><pre><span></span><span class="n">ict</span><span class="o">-</span><span class="n">lxb</span><span class="err">@</span><span class="n">ictlxb</span><span class="o">-</span><span class="n">Zhaoyang</span><span class="o">-</span><span class="nl">E49</span><span class="p">:</span><span class="o">~/</span><span class="n">Workspace</span><span class="o">/</span><span class="n">test</span><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">matrix_4097</span> 
<span class="mi">4097</span> <span class="n">matrix</span> <span class="n">multiply</span>
<span class="nl">time</span> <span class="p">:</span> <span class="mi">901</span><span class="n">s</span> <span class="nl">speed</span><span class="p">:</span> <span class="mf">152.52</span> <span class="n">MFLOPS</span>
</pre></div>


<h4>2.3 Conclusion</h4>
<p>After analysing the results above, we can see that the performance was improved
due in large part to cache miss rate decreasing. 4097 matrix might decrease the
collision of cache line becuase of its irregular layout.</p>
<h3>3 Three Loops Resulotion With Transpose</h3>
<h4>3.1 Source Code</h4>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp"></span>

<span class="cp">#define DIM 4096</span>
<span class="k">typedef</span> <span class="nf">double</span><span class="p">(</span><span class="o">*</span> <span class="n">MATRIX</span><span class="p">)[</span><span class="n">DIM</span><span class="p">];</span>

<span class="kt">void</span> <span class="nf">transpose</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">row</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">];</span>
            <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">row</span><span class="p">];</span>
            <span class="n">m</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">z</span><span class="p">,</span> <span class="k">const</span> <span class="n">MATRIX</span> <span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="n">MATRIX</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>

    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="n">transpose</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dim</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">idx</span><span class="p">];</span>
            <span class="n">z</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init_matrix</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isRandom</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isRandom</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">srandom</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span>
                <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">263</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_matrix</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%f &quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MATRIX</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">MATRIX</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">MATRIX</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">multiply</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">DIM</span><span class="p">);</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">DIM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">opts</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">time</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d matrix multiply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DIM</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;time : %ds</span><span class="se">\t</span><span class="s">speed: %.2f MFLOPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h4>3.2 Results</h4>
<div class="highlight"><pre><span></span>ct-lxb@ictlxb-Zhaoyang-E49:~/Workspace/test$ ./matrix_transpose 
<span class="m">4096</span> matrix multiply
<span class="nb">time</span> : 72s  speed: 1908.64 MFLOPS
</pre></div>


<h4>3.3 Conclusion</h4>
<p>After analysing the results above, we can see that the performance is improved
so much. The reasons for that might be that the array in C program language is
row-major and that cache miss rate decreases due to the transpose. Temporal
locality and spatial locality is the key point in this improvement.</p>
<h3>4 Three Loops Resulotion With Partition</h3>
<h4>4.1 Source Code</h4>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp"></span>

<span class="cp">#define B 128</span>
<span class="cp">#define DIM 4096</span>
<span class="k">typedef</span> <span class="nf">double</span><span class="p">(</span><span class="o">*</span> <span class="n">MATRIX</span><span class="p">)[</span><span class="n">DIM</span><span class="p">];</span>

<span class="cp">#define MIN(x, y) ((x) &gt; (y) ? (y) : (x))</span>

<span class="kt">void</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">z</span><span class="p">,</span> <span class="k">const</span> <span class="n">MATRIX</span> <span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="n">MATRIX</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ri</span><span class="p">,</span> <span class="n">ci</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">+=</span><span class="n">B</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">+=</span><span class="n">B</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ri</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">ri</span><span class="o">++</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">ci</span> <span class="o">=</span> <span class="n">col</span><span class="p">;</span> <span class="n">ci</span> <span class="o">&lt;</span> <span class="n">MIN</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">col</span><span class="o">+</span><span class="n">B</span><span class="p">);</span> <span class="n">ci</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">col</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">MIN</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">col</span><span class="o">+</span><span class="n">B</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
                        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">ri</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">ci</span><span class="p">];</span>
                    <span class="n">z</span><span class="p">[</span><span class="n">ri</span><span class="p">][</span><span class="n">ci</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
                <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init_matrix</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isRandom</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isRandom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span>
                <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">263</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_matrix</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%f &quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">srandom</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
<span class="cp">#if 1</span>
    <span class="n">MATRIX</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">MATRIX</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">MATRIX</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="kt">double</span> <span class="n">x</span><span class="p">[</span><span class="n">DIM</span><span class="p">][</span><span class="n">DIM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
        <span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">}</span>
    <span class="p">};</span>
    <span class="kt">double</span> <span class="n">y</span><span class="p">[</span><span class="n">DIM</span><span class="p">][</span><span class="n">DIM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
        <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
    <span class="p">};</span>
    <span class="kt">double</span> <span class="n">z</span><span class="p">[</span><span class="n">DIM</span><span class="p">][</span><span class="n">DIM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
    <span class="p">};</span>
<span class="cp">#endif</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">multiply</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">DIM</span><span class="p">);</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">DIM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">opts</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">time</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d matrix multiply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DIM</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;time : %ds</span><span class="se">\t</span><span class="s">speed: %.2f MFLOPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    print_matrix(x, DIM);</span>
<span class="c">    print_matrix(y, DIM);</span>
<span class="c">    print_matrix(z, DIM);</span>
<span class="cp">#endif</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h4>4.2 Results</h4>
<p><img alt="b-mflops" src="/assets/images/b_mflops.png" /></p>
<h4>4.3 Conclusion</h4>
<p>After analysing the results above, we can see that the performance is optimal
when B is 64.</p>
<h3>5 Serial Program Analysis</h3>
<p>From all the experiments above, we can see that the bottlenect of the serial
program (matrix multiply) is memory access delay. With some optimization such
as instructions reordering by compilers, improving temporal locality and
spatial locality of data, the performance could be improved due to less cache
misses.</p>
<h3>6 Optimal Program With Pthread</h3>
<h4>6.1 Source Code</h4>
<div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>

<span class="cp">#define CORES 2</span>
<span class="cp">#define THREADS 4</span>
<span class="cp">#define WORKERS (THREADS)</span>


<span class="cp">#define DIM 4096</span>
<span class="cp">#define COL (DIM/WORKERS)</span>
<span class="k">typedef</span> <span class="nf">double</span><span class="p">(</span><span class="o">*</span> <span class="n">MATRIX</span><span class="p">)[</span><span class="n">DIM</span><span class="p">];</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">MATRIX</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">MATRIX</span> <span class="n">y</span><span class="p">;</span>
    <span class="n">MATRIX</span> <span class="n">z</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">row_start</span><span class="p">;</span>
    <span class="n">pthread_t</span> <span class="n">pid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Arguments</span><span class="p">;</span>

<span class="n">Arguments</span> <span class="n">argument</span><span class="p">[</span><span class="n">WORKERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">},</span> <span class="p">};</span>

<span class="kt">void</span> <span class="nf">print_matrix</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%f &quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">transpose</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">row</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">];</span>
            <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">row</span><span class="p">];</span>
            <span class="n">m</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">multiply</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">z</span><span class="p">,</span> <span class="k">const</span> <span class="n">MATRIX</span> <span class="n">x</span><span class="p">,</span> <span class="k">const</span> <span class="n">MATRIX</span> <span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">row_offset</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">end</span> <span class="o">=</span> <span class="n">row_offset</span> <span class="o">+</span> <span class="n">COL</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="n">row_offset</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">DIM</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">DIM</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">idx</span><span class="p">];</span>
            <span class="n">z</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="o">*</span> <span class="nf">worker</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Arguments</span><span class="o">*</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">Arguments</span><span class="o">*</span> <span class="p">)</span><span class="n">arg</span><span class="p">;</span>
    <span class="n">multiply</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">z</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">row_start</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init_matrix</span><span class="p">(</span><span class="n">MATRIX</span> <span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dim</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isRandom</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isRandom</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">srandom</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">row</span><span class="o">++</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">)</span>
                <span class="n">m</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="p">()</span> <span class="o">%</span> <span class="mi">263</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">dim</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">MATRIX</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">MATRIX</span> <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">MATRIX</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">MATRIX</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">init_matrix</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">transpose</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">DIM</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WORKERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">argument</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="n">argument</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
        <span class="n">argument</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">;</span>
        <span class="n">argument</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">row_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">COL</span><span class="p">;</span>
        <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argument</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argument</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">multiply</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WORKERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">pthread_join</span><span class="p">(</span><span class="n">argument</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">end</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">-</span><span class="n">start</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">opts</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">DIM</span><span class="o">*</span><span class="n">DIM</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">DIM</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="kt">double</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">opts</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">time</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d matrix multiply with %d workers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DIM</span><span class="p">,</span> <span class="n">WORKERS</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;time : %ds</span><span class="se">\t</span><span class="s">speed: %.2f MFLOPS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h4>6.2 Results</h4>
<div class="highlight"><pre><span></span>ict-lxb@ictlxb-Zhaoyang-E49:~/Workspace/test$ ./matrix_pthread 
<span class="m">4096</span> matrix multiply with <span class="m">2</span> workers
<span class="nb">time</span> : 49s  speed: 2804.53 MFLOPS

ict-lxb@ictlxb-Zhaoyang-E49:~/Workspace/test$ ./matrix_pthread 
<span class="m">4096</span> matrix multiply with <span class="m">4</span> workers
<span class="nb">time</span> : 31s  speed: 4432.97 MFLOPS

ict-lxb@ictlxb-Zhaoyang-E49:~/Workspace/test$ ./matrix_pthread 
<span class="m">4096</span> matrix multiply with <span class="m">8</span> workers
<span class="nb">time</span> : 44s  speed: 3123.23 MFLOPS

ict-lxb@ictlxb-Zhaoyang-E49:~/Workspace/test$ ./matrix_pthread 
<span class="m">4096</span> matrix multiply with <span class="m">16</span> workers
<span class="nb">time</span> : 43s  speed: 3195.86 MFLOPS

...

ict-lxb@ictlxb-Zhaoyang-E49:~/Workspace/test$ ./matrix_pthread 
<span class="m">4096</span> matrix multiply with <span class="m">4096</span> workers
<span class="nb">time</span> : 42s  speed: 3271.96 MFLOPS
</pre></div>


<ul>
<li>
<p>rate = 72 / 49 = 1.47</p>
</li>
<li>
<p>rate = 72 / 31 = 2</p>
</li>
<li>
<p>rate = 72 / 44 = 1.64</p>
</li>
</ul>
<h4>6.3 Conclusion</h4>
<p>After analysing the results above, we can see that the performance is imporved
so much that 4096 matrix multiply with 16 workers took only 43 seconds.
Parallel optimization can improve the performance in a reasonable way. However,
With the number of workers increasing, the performance did not decrease as
expected, I guess thread switch might be optimized so well that the cost could
be ignored.</p>
<h3>7 Optimization With BLAS (optional)</h3>
<p>(To be continued)</p></div>
        <hr />
    </div>
		
<div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="../tag/optimization.html">1</a></li>

    <li class="next disabled"><a href="#">&rarr; Next</a></li>

</ul>
</div>
 
  
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <li><a href="../archives.html">Archives</a>
                <li><a href="../tags.html">Tags</a>



                <li><a href="http://gotit.applinzi.com/feeds/all.atom.xml" rel="alternate">Atom feed</a></li>

            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                <li><a href="../category/ccpp.html">C/CPP</a></li>
                <li><a href="../category/english.html">English</a></li>
                <li><a href="../category/linux.html">Linux</a></li>
                <li><a href="../category/security.html">Security</a></li>
                   
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Links
                </li>
            
                <li><a href="http://getpelican.com/">Pelican</a></li>
                <li><a href="http://python.org/">Python.org</a></li>
                <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
            </ul>
            </div>


            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                <li><a href="https://github.com/buptlxb">Github</a></li>
                <li><a href="http://weibo.com/ictlxb">Weibo</a></li>
            </ul>
            </div>


            <div class="tagcloud">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="tagcloud">
            </ul>
            </div>

            </div>


        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href="..">BLxG</a> &copy; ictlxb 2014</p>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="../theme/bootstrap-collapse.js"></script>
<script>
    $(document).ready(function () {
        $(".article table").addClass("table table-striped table-bordered");
    });
</script>

 
</body>
</html>