<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>BLxG</title>
    <meta name="author" content="ictlxb">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta property="wb:webmaster" content="35e06a32947da88a" />

    <meta name="description" content="Programming and Life -- http://www.gotit.sinaapp.com">
    <meta name="keywords" content="算法,软件开发,Algorithm,C++,Coding,Debug,Google,Linux,,OS,,Programmer,programming,language,Python,Ubuntu,Unix,vim">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="../theme/html5.js"></script>
    <![endif]-->
    <link rel="shortcut icon" href="../theme/images/icons/favicon.ico"/>
    <link rel="bookmark" href="../theme/images/icons/favicon.ico"/>
    <!-- Le styles -->
    <link href="../theme/bootstrap.min.css" rel="stylesheet">
    <link href="../theme/bootstrap.min.responsive.css" rel="stylesheet">
    <link href="../theme/local.css" rel="stylesheet">
    <link href="../theme/pygments.css" rel="stylesheet">

    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="http://gotit.applinzi.com/feeds/all.atom.xml" rel="alternate" title="BLxG" type="application/atom+xml">

</head>

<body>

<div class="navbar">
    <div class="navbar-inner">
    <div class="container">

         <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
             <span class="icon-bar"></span>
         </a>

        <a class="brand" href="..">BLxG</a>

        <div class="nav-collapse">
        <ul class="nav">
            
            <li><a href="../pages/about.html">About</a></li>
        </ul>
        </div>
        
    </div>
    </div>
</div>

<div class="container">
    <div class="content">
    <div class="row">

        <div class="span9">
        

        


    <div class='article'>
        <div class="content-title">
            <a href="../yet-another-toy-compiler-compiler.html"><h1>Yet Another Toy Compiler Compiler</h1></a>
五 11 十一月 2016

by <a class="url fn" href="../author/ictlxb.html">ictlxb</a>
 

Filed under <a href="../category/ccpp.html">C/CPP</a>

 
    Tags <a href="../tag/c.html">c</a> <a href="../tag/compiler.html">compiler</a> <a href="../tag/regular-expression.html">regular expression</a> <a href="../tag/automaton.html">automaton</a>  
        </div>
        
        <div><blockquote>
<p>If all you have is a hammer, everything looks like a nail.  ---Maslow </p>
</blockquote>
<h2>前言</h2>
<p>忽然又有了些时间，所以又开始折腾，又要再尝试学习编译器，学习编译原理。希望这能是一个系统的文章，让我有一天能够看到曾经不堪的自己。
最近看的书叫编译器设计，译自<em>Engineering a Compiler</em>
第二版。当前进度第二章。相比原来的情况，明白了如何写一个词法分析器的生成器，其步骤如下：</p>
<p>（假设词法结构由正则表达到式描述）
1. 将中缀形式的正则表达式转换为后缀表达式。（此处我只考虑了正则表达式的连接、选择和闭包操作）
2. 利用Thompson算法，将后缀形式的正则表达式，转换为非确定性有限自动机(NFA, Nondeterministic Finite Automaton)。
3. 利用子集构造法，将NFA转换为确定性有限自动机(DFA, Deterministic Finite Automaton)。
4. 利用Hopcroft算法，将DFA最小化。
5. 最小化后的DFA可以用来作为Tokenizer。</p>
<h2>玩具</h2>
<p>根据书中的描述，勉强实现了部分玩具功能，这么代码做了很大的简化，并且以功能实现为主。</p>
<h3>中缀转后缀</h3>
<p>按照之前的设想，支持的正则表达式，只有连接、选择和闭包三种操作，并允许括号来改变优先级。</p>
<p>Token的类型和定义如下：</p>
<div class="highlight"><pre><span></span><span class="k">enum</span> <span class="k">class</span> <span class="nc">TokenType</span><span class="p">{</span>
    <span class="n">OPERAND</span><span class="p">,</span>
    <span class="n">STAR</span><span class="p">,</span>
    <span class="n">CONCATENATE</span><span class="p">,</span>
    <span class="n">BAR</span><span class="p">,</span>
    <span class="n">LEFT_PARENTTHESIS</span><span class="p">,</span> <span class="c1">// always pushed into stack </span>
    <span class="n">RIGHT_PARENTHESIS</span>  <span class="c1">// never pushed into stack</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">Token</span> <span class="p">{</span>
    <span class="n">TokenType</span> <span class="n">type</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>


<p>中缀表达式转后缀表达式时，运行符优先级由TokenType给出，越早出现的优先级越高。</p>
<div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span> <span class="n">postfix2postfix</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">tokens</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span> <span class="n">postfix</span><span class="p">;</span>
    <span class="n">postfix</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">tokens</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">std</span><span class="o">::</span><span class="n">stack</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span> <span class="n">st</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">token</span> <span class="p">:</span> <span class="n">tokens</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TokenType</span><span class="o">::</span><span class="n">OPERAND</span><span class="p">)</span>
            <span class="n">postfix</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">TokenType</span><span class="o">::</span><span class="n">RIGHT_PARENTHESIS</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">st</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">TokenType</span><span class="o">::</span><span class="n">LEFT_PARENTTHESIS</span> <span class="o">!=</span> <span class="n">st</span><span class="p">.</span><span class="n">top</span><span class="p">().</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">postfix</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">top</span><span class="p">());</span>
                <span class="n">st</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">st</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">TokenType</span><span class="o">::</span><span class="n">LEFT_PARENTTHESIS</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">st</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">token</span><span class="p">.</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">st</span><span class="p">.</span><span class="n">top</span><span class="p">().</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">postfix</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">top</span><span class="p">());</span>
                    <span class="n">st</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">st</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">st</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">postfix</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">top</span><span class="p">());</span>
        <span class="n">st</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">postfix</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h3>Thompson算法</h3>
<p>通过后缀表达式求值的方法，可以将正则表达式转换为NFA。</p>
<div class="highlight"><pre><span></span><span class="cp">#define NFA_UNARY(st, op) do { \</span>
<span class="cp">    assert(st.size() &gt;= 1); \</span>
<span class="cp">    auto rhs = st.top(); \</span>
<span class="cp">    st.pop(); \</span>
<span class="cp">    st.emplace(op rhs); \</span>
<span class="cp">} while(0)</span>

<span class="cp">#define NFA_BINARY(st, op) do { \</span>
<span class="cp">    assert(st.size() &gt;= 2); \</span>
<span class="cp">    auto rhs = st.top(); \</span>
<span class="cp">    st.pop(); \</span>
<span class="cp">    auto lhs = st.top(); \</span>
<span class="cp">    st.pop(); \</span>
<span class="cp">    st.emplace(lhs op rhs); \</span>
<span class="cp">} while(0)</span>

<span class="n">NFA</span> <span class="nf">Thompson</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">re</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">stack</span><span class="o">&lt;</span><span class="n">NFA</span><span class="o">&gt;</span> <span class="n">st</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">token</span> <span class="p">:</span> <span class="n">re</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">TokenType</span><span class="o">::</span><span class="nl">OPERAND</span><span class="p">:</span>
                <span class="n">st</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">TokenType</span><span class="o">::</span><span class="nl">STAR</span><span class="p">:</span>
                <span class="n">NFA_UNARY</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="o">*</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">TokenType</span><span class="o">::</span><span class="nl">CONCATENATE</span><span class="p">:</span>
                <span class="n">NFA_BINARY</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="o">+</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">TokenType</span><span class="o">::</span><span class="nl">BAR</span><span class="p">:</span>
                <span class="n">NFA_BINARY</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="o">|</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="n">abort</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">st</span><span class="p">.</span><span class="n">top</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<h3>NFA实现</h3>
<p>由Thompson算法生成的NFA主要有以下特点：</p>
<ol>
<li>NFA有且仅有一个开始状态和一个接受状态。</li>
<li>开始状态没有入边，接受状态没有出边。</li>
</ol>
<p>因此，我最初设计的NFA抽象成如下代码：</p>
<div class="highlight"><pre><span></span><span class="k">constexpr</span> <span class="kt">char</span> <span class="n">EPSILON</span> <span class="o">=</span> <span class="sc">&#39;\xFF&#39;</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">FANode</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">prev</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">multimap</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">next</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">isAccepted</span><span class="p">;</span>
    <span class="n">FANode</span> <span class="p">()</span> <span class="o">:</span> <span class="n">isAccepted</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">NFA</span> <span class="p">{</span>
    <span class="n">FANode</span> <span class="o">*</span><span class="n">s0</span><span class="p">,</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">NFA</span> <span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="o">=</span><span class="n">EPSILON</span><span class="p">)</span> <span class="o">:</span> <span class="n">s0</span><span class="p">(</span><span class="k">new</span> <span class="n">FANode</span><span class="p">),</span> <span class="n">sa</span><span class="p">(</span><span class="k">new</span> <span class="n">FANode</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s0</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
        <span class="n">sa</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">s0</span><span class="p">);</span>
        <span class="n">sa</span><span class="o">-&gt;</span><span class="n">isAccepted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">NFA</span> <span class="p">(</span><span class="k">const</span> <span class="n">NFA</span> <span class="o">*</span><span class="n">that</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*</span><span class="p">,</span> <span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">dict</span><span class="p">;</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">;</span>
        <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="o">-&gt;</span><span class="n">s0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s0</span><span class="p">;</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">;</span>
        <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">;</span>
        <span class="n">sa</span><span class="o">-&gt;</span><span class="n">isAccepted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">copy</span><span class="p">(</span><span class="n">that</span><span class="o">-&gt;</span><span class="n">s0</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">NFA</span> <span class="p">(</span><span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*</span><span class="p">,</span> <span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">dict</span><span class="p">;</span>
        <span class="n">s0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">;</span>
        <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s0</span><span class="p">;</span>
        <span class="n">sa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">;</span>
        <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="p">.</span><span class="n">sa</span><span class="p">]</span> <span class="o">=</span> <span class="n">sa</span><span class="p">;</span>
        <span class="n">sa</span><span class="o">-&gt;</span><span class="n">isAccepted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">copy</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">NFA</span> <span class="p">(</span><span class="n">NFA</span> <span class="o">&amp;&amp;</span><span class="n">that</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">s0</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">;</span>
        <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">sa</span><span class="p">;</span>
        <span class="n">that</span><span class="p">.</span><span class="n">s0</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">sa</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">~</span><span class="n">NFA</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s0</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">mem</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">q</span><span class="p">;</span>
        <span class="n">q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">s0</span><span class="p">);</span>
        <span class="n">mem</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">s0</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">auto</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
            <span class="n">q</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">n</span> <span class="p">:</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="o">==</span> <span class="n">mem</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
                    <span class="n">q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
                    <span class="n">mem</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">delete</span> <span class="n">cur</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">NFA</span> <span class="k">operator</span><span class="o">+</span> <span class="p">(</span><span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">NFA</span> <span class="k">operator</span><span class="o">|</span> <span class="p">(</span><span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">NFA</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span> <span class="p">();</span>
    <span class="n">NFA</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">+=</span> <span class="p">(</span><span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="p">);</span>
    <span class="n">NFA</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">|=</span> <span class="p">(</span><span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_mermaid</span><span class="p">();</span>
<span class="k">private</span><span class="o">:</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="n">copy</span><span class="p">(</span><span class="n">FANode</span> <span class="o">*</span><span class="n">s0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*</span><span class="p">,</span> <span class="n">FANode</span> <span class="o">*&gt;</span> <span class="o">&amp;</span><span class="n">dict</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">q</span><span class="p">;</span>
        <span class="n">q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">s0</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">auto</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
            <span class="n">q</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">n</span> <span class="p">:</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dict</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="o">==</span> <span class="n">dict</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
                    <span class="n">dict</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">,</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">);</span>
                    <span class="n">q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">dict</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">dict</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">]);</span>
                <span class="n">dict</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">dict</span><span class="p">[</span><span class="n">cur</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">friend</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="n">os</span><span class="p">,</span> <span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="n">nfa</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>


<p>每个NFA记录了其开始状态和接受状态，便于进行NFA的连接、选择和闭包操作。然而，这也导致了我在抽象DFA时陷入了两难的窘境：</p>
<ul>
<li>DFA是一种特殊的NFA，故NFA支持的操作逻辑上DFA都应该支持</li>
<li>然而，DFA未必只有一个终结态，其不满足我简化后的NFA类的特征。</li>
</ul>
<p>此致，在抽象NFA时，我将状态的转移关系直接维护在状态中，使用multimap进行管理。这种方式实现简单，却使得正则表达式中的范围操作如[a-Z]非常昂贵。
下一步，准备将转移关系也抽象出来，并支持范围操作。</p>
<p>下面是目前支持的三种操作，连接(operator+)、选择(operator|) 和 闭包(operator*)：</p>
<div class="highlight"><pre><span></span><span class="n">NFA</span> <span class="n">NFA</span><span class="o">::</span><span class="k">operator</span><span class="o">+</span> <span class="p">(</span><span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">NFA</span> <span class="n">res</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">+=</span> <span class="n">that</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NFA</span> <span class="n">NFA</span><span class="o">::</span><span class="k">operator</span><span class="o">|</span> <span class="p">(</span><span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">NFA</span> <span class="n">res</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">|=</span> <span class="n">that</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NFA</span> <span class="o">&amp;</span> <span class="n">NFA</span><span class="o">::</span><span class="k">operator</span><span class="o">*</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;star(NFA@0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="n">FANode</span> <span class="o">*</span><span class="n">ns0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">,</span> <span class="o">*</span><span class="n">nsa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">;</span>
    <span class="n">nsa</span><span class="o">-&gt;</span><span class="n">isAccepted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">isAccepted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">EPSILON</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">s0</span><span class="p">);</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">EPSILON</span><span class="p">,</span> <span class="n">nsa</span><span class="p">);</span>
    <span class="n">nsa</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">);</span>

    <span class="n">ns0</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">EPSILON</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">s0</span><span class="p">);</span>
    <span class="n">ns0</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">EPSILON</span><span class="p">,</span> <span class="n">nsa</span><span class="p">);</span>

    <span class="k">this</span><span class="o">-&gt;</span><span class="n">s0</span> <span class="o">=</span> <span class="n">ns0</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NFA</span> <span class="o">&amp;</span> <span class="n">NFA</span><span class="o">::</span><span class="k">operator</span><span class="o">+=</span> <span class="p">(</span><span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;NFA@0x%p + NFA@0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">);</span>
    <span class="n">assertm</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">empty</span><span class="p">(),</span> <span class="s">&quot;The accepted state of NFA@0x%p should not have any succeeding&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">isAccepted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*</span><span class="p">,</span> <span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">dict</span><span class="p">;</span>

    <span class="n">dict</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">,</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">);</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">EPSILON</span><span class="p">,</span> <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">]);</span>
    <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">);</span>

    <span class="n">dict</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">sa</span><span class="p">,</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">);</span>
    <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="p">.</span><span class="n">sa</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">isAccepted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">copy</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span> <span class="o">=</span> <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="p">.</span><span class="n">sa</span><span class="p">];</span>

    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NFA</span> <span class="o">&amp;</span> <span class="n">NFA</span><span class="o">::</span><span class="k">operator</span><span class="o">|=</span> <span class="p">(</span><span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;NFA@0x%p | NFA@0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">that</span><span class="p">);</span>
    <span class="n">FANode</span> <span class="o">*</span><span class="n">ns0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">,</span> <span class="o">*</span><span class="n">nsa</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">;</span>
    <span class="n">nsa</span><span class="o">-&gt;</span><span class="n">isAccepted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

    <span class="n">ns0</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">EPSILON</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">s0</span><span class="p">);</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">s0</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ns0</span><span class="p">);</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">isAccepted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">EPSILON</span><span class="p">,</span> <span class="n">nsa</span><span class="p">);</span>
    <span class="n">nsa</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">);</span>

    <span class="k">this</span><span class="o">-&gt;</span><span class="n">s0</span> <span class="o">=</span> <span class="n">ns0</span><span class="p">;</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span> <span class="o">=</span> <span class="n">nsa</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*</span><span class="p">,</span> <span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">dict</span><span class="p">;</span>

    <span class="n">dict</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">,</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">);</span>
    <span class="n">ns0</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">EPSILON</span><span class="p">,</span> <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">]);</span>
    <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ns0</span><span class="p">);</span>
    <span class="n">dict</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">sa</span><span class="p">,</span> <span class="k">new</span> <span class="n">FANode</span><span class="p">);</span>
    <span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="p">.</span><span class="n">sa</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">EPSILON</span><span class="p">,</span> <span class="n">nsa</span><span class="p">);</span>
    <span class="n">nsa</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">dict</span><span class="p">[</span><span class="n">that</span><span class="p">.</span><span class="n">sa</span><span class="p">]);</span>
    <span class="n">copy</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">s0</span><span class="p">,</span> <span class="n">dict</span><span class="p">);</span>

    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>下面是一些NFA的格式化输出，用于方便地观察生成的NFA的形态。感谢<a href="https://github.com/knsv/mermaid">mermaid</a>可以允许以图形的方式查看我的NFA。</p>
<div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="n">os</span><span class="p">,</span> <span class="k">const</span> <span class="n">FANode</span> <span class="o">*</span><span class="n">fan</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;0x&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">hex</span> <span class="o">&lt;&lt;</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&gt;</span><span class="p">(</span><span class="n">fan</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">dec</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fan</span><span class="o">-&gt;</span><span class="n">isAccepted</span><span class="p">)</span>
        <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;[$]&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="n">os</span><span class="p">,</span> <span class="k">const</span> <span class="n">FANode</span> <span class="o">&amp;</span><span class="n">fan</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">operator</span><span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fan</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="n">os</span><span class="p">,</span> <span class="k">const</span> <span class="n">NFA</span> <span class="o">&amp;</span><span class="n">nfa</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">q</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">mem</span><span class="p">;</span>
    <span class="n">q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">nfa</span><span class="p">.</span><span class="n">s0</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">auto</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
            <span class="n">q</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">cur</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;=&gt;{&quot;</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="o">==</span> <span class="n">mem</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">isAccepted</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">mem</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
                    <span class="n">q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">.</span><span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">.</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;;&quot;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;};&quot;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">NFA</span><span class="o">::</span><span class="n">to_mermaid</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">os</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*&gt;</span> <span class="n">q</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">FANode</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span><span class="o">&gt;</span> <span class="n">dict</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s0</span><span class="p">);</span>
    <span class="n">dict</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">s0</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
    <span class="n">dict</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">auto</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">q</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
            <span class="n">q</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
            <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dict</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="o">==</span> <span class="n">dict</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
                    <span class="n">dict</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">,</span> <span class="n">index</span><span class="o">++</span><span class="p">);</span>
                    <span class="n">q</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;s&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dict</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;--&quot;</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">first</span> <span class="o">==</span> <span class="n">EPSILON</span><span class="p">)</span>
                    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;eplisoin&quot;</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;--&gt;&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;s&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dict</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">isAccepted</span><span class="p">)</span>
                    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;((&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;s&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">dict</span><span class="p">[</span><span class="n">n</span><span class="p">.</span><span class="n">second</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;))&quot;</span><span class="p">;</span>
                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<h3>测试</h3>
<p>由于没有实现对正则表达式的Tokenizer，输出的中缀形式的正则表达式，只有以丑陋的手工方式进行Token分割。（鸡生蛋，蛋生鸡呀，我在写一个Lexer
Compiler啊）</p>
<div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span> <span class="n">postfix</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenType</span><span class="o">::</span><span class="n">OPERAND</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="n">TokenType</span><span class="o">::</span><span class="n">CONCATENATE</span><span class="p">,</span> <span class="sc">&#39;+&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="n">TokenType</span><span class="o">::</span><span class="n">LEFT_PARENTTHESIS</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="n">TokenType</span><span class="o">::</span><span class="n">OPERAND</span><span class="p">,</span> <span class="sc">&#39;b&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="n">TokenType</span><span class="o">::</span><span class="n">BAR</span><span class="p">,</span> <span class="sc">&#39;|&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="n">TokenType</span><span class="o">::</span><span class="n">OPERAND</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="n">TokenType</span><span class="o">::</span><span class="n">RIGHT_PARENTHESIS</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="n">TokenType</span><span class="o">::</span><span class="n">STAR</span><span class="p">,</span> <span class="sc">&#39;*&#39;</span><span class="p">}</span>
<span class="p">};</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;</span> <span class="n">tokens</span> <span class="o">=</span> <span class="n">postfix2postfix</span><span class="p">(</span><span class="n">postfix</span><span class="p">);</span>

<span class="n">NFA</span> <span class="n">res</span> <span class="o">=</span> <span class="n">Thompson</span><span class="p">(</span><span class="n">tokens</span><span class="p">);</span>

<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">res</span><span class="p">.</span><span class="n">to_mermaid</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></div>


<p>输出：</p>
<div class="highlight"><pre><span></span>s0--a--&gt;s2
s2--eplisoin--&gt;s3
s3--eplisoin--&gt;s4
s3--eplisoin--&gt;s1<span class="o">((</span>s1<span class="o">))</span>
s4--eplisoin--&gt;s5
s4--eplisoin--&gt;s6
s5--b--&gt;s7
s6--c--&gt;s8
s7--eplisoin--&gt;s9
s8--eplisoin--&gt;s9
s9--eplisoin--&gt;s4
s9--eplisoin--&gt;s1<span class="o">((</span>s1<span class="o">))</span>
</pre></div>


<p>借助mermaid可视化为：</p>
<p><img alt="mermaid" src="/assets/images/nfa.png" /></p>
<p>(期待我还能写一篇)</p></div>
        <hr />
    </div>
		
<div class="pagination">
<ul>
    <li class="prev disabled"><a href="#">&larr; Previous</a></li>

    <li class="active"><a href="../tag/regular-expression.html">1</a></li>

    <li class="next disabled"><a href="#">&rarr; Next</a></li>

</ul>
</div>
 
  
        </div>
        
        <div class="span3">

            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Site
                </li>
            
                <li><a href="../archives.html">Archives</a>
                <li><a href="../tags.html">Tags</a>



                <li><a href="http://gotit.applinzi.com/feeds/all.atom.xml" rel="alternate">Atom feed</a></li>

            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Categories
                </li>
                
                <li><a href="../category/ccpp.html">C/CPP</a></li>
                <li><a href="../category/english.html">English</a></li>
                <li><a href="../category/linux.html">Linux</a></li>
                <li><a href="../category/security.html">Security</a></li>
                   
            </ul>
            </div>


            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Links
                </li>
            
                <li><a href="http://getpelican.com/">Pelican</a></li>
                <li><a href="http://python.org/">Python.org</a></li>
                <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
            </ul>
            </div>


            <div class="social">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="nav nav-list">
                <li class="nav-header"> 
                Social
                </li>
           
                <li><a href="https://github.com/buptlxb">Github</a></li>
                <li><a href="http://weibo.com/ictlxb">Weibo</a></li>
            </ul>
            </div>


            <div class="tagcloud">
            <div class="well" style="padding: 8px 0; background-color: #FBFBFB;">
            <ul class="tagcloud">
            </ul>
            </div>

            </div>


        </div>  
    </div>     </div> 
<footer>
<br />
<p><a href="..">BLxG</a> &copy; ictlxb 2016</p>
</footer>

</div> <!-- /container -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="../theme/bootstrap-collapse.js"></script>
<script>
    $(document).ready(function () {
        $(".article table").addClass("table table-striped table-bordered");
    });
</script>

 
</body>
</html>